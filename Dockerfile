FROM node

ARG PORT=3000

# Set the working directory in the container
WORKDIR /app

# Set node environment to production
ENV NODE_ENV production

# Update npm first
RUN npm install -g npm

# Install PM2: Advanced process manager for production Node.js applications. Load balancer, logs facility, startup script, micro service management, at a glance.
RUN npm i -g pm2

# Copy package.json and package-lock.json and process.yml to the working directory
COPY package*.json process.yml ./

# Prepare destination directory and ensure user node owns it
RUN chown -R node:node /app

# Switch to node user
USER node

# Install libraries as user node
RUN npm i --only=production
# COPY ./src /api
# Copy the rest of the code
COPY . .  

# Expose the port on which your Node.js application will run
EXPOSE ${PORT}

# Use PM2 to run the application as stated in config file
ENTRYPOINT ["pm2-runtime", "./process.yml"] 
# Use js files to run the application
#ENTRYPOINT ["node", "./src/index.js"]
#CMD ["npm", "start"